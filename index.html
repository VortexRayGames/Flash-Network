<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>‚ö°Ô∏èFlash Network‚ö°Ô∏è</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <meta name="theme-color" content="#ff3b30">
  <link rel="manifest" href="manifest.json">
  <style>
    *{box-sizing:border-box;margin:0;font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",sans-serif;}
    body{background:#fff;color:#000;height:100vh;display:flex;flex-direction:column;overflow:hidden}
    .page{flex:1;display:flex;flex-direction:column;animation:fade .3s}
    @keyframes fade{from{opacity:.6}}
    .hidden{display:none}
    /* auth */
    #authPage{background:#ff3b30;color:#fff;justify-content:center;align-items:center;text-align:center;padding:20px}
    #authPage input{padding:12px;margin:8px 0;width:100%;max-width:280px;border:none;border-radius:6px}
    #authPage button{background:#fff;color:#ff3b30;border:none;padding:12px 24px;border-radius:6px;font-weight:bold;width:100%;max-width:280px}
    /* camera */
    #cameraView{flex:1;position:relative;background:#000}
    #video{width:100%;height:100%;object-fit:cover}
    #snapBtn{width:64px;height:64px;border-radius:50%;background:transparent;border:3px solid #ff3b30;position:absolute;bottom:90px;left:50%;transform:translateX(-50%);box-shadow:0 0 0 4px #000}
    /* nav */
    nav{height:60px;background:#fff;display:flex;justify-content:space-around;align-items:center;border-top:1px solid #ddd}
    nav button{background:none;border:none;color:#888;font-size:22px;flex:1;height:100%}
    nav button.active{color:#ff3b30}
    /* chat */
    #chatList{flex:1;overflow:auto;padding:10px}
    .chat{padding:10px;border-bottom:1px solid #eee;display:flex;align-items:center}
    .chat img.avatar{width:40px;height:40px;border-radius:50%;margin-right:10px;background:#ff3b30;color:#fff;display:flex;align-items:center;justify-content:center;font-size:20px;object-fit:cover}
    /* text bubbles */
    #textChat{flex:1;overflow:auto;padding:10px;background:#fafafa}
    .bubble{max-width:70%;padding:8px 12px;margin:4px 0;border-radius:16px;font-size:15px}
    .mine{background:#ff3b30;color:#fff;margin-left:auto}
    .theirs{background:#e5e5ea;color:#000}
    /* message input bar */
    #textBar{display:flex;border-top:1px solid #ddd;padding:6px;background:#fff}
    #textBar input{flex:1;border:none;padding:8px;font-size:16px}
    #textBar button{background:#ff3b30;color:#fff;border:none;padding:8px 14px;border-radius:20px;margin-left:6px}

    /* stories */
    #storiesList{display:flex;gap:10px;padding:10px;overflow-x:auto;background:#fafafa}
    .storySlot{flex:0 0 80px;text-align:center;font-size:12px}
    .storySlot img{width:64px;height:64px;border-radius:50%;border:3px solid #ff3b30;object-fit:cover}
    #storyViewer{position:fixed;inset:0;background:#000;z-index:999;display:flex;align-items:center;justify-content:center}
    #storyViewer img{max-width:100%;max-height:100%}
    #storyViewer button{position:absolute;top:10px;right:10px;background:#ff3b30;color:#fff;border:none;padding:6px 12px;border-radius:6px}

    /* games */
    #gameBoard{flex:1;display:flex;align-items:center;justify-content:center;background:#1a1a1a}
    /* stories & games placeholder */
    .placeholder{padding:30px;text-align:center;color:#999}
  </style>
</head>
<body>

  <!-- AUTH -->
  <div id="authPage" class="page">
    <h1>‚ö°Ô∏èFlash Network‚ö°Ô∏è</h1>
    <input id="email" placeholder="Email">
    <input id="pass" type="password" placeholder="Password">
    <button onclick="login()">Log In</button>
    <button onclick="register()">Register</button>
    <div id="avatarPicker"></div>
    <input id="pngUpload" type="file" accept="image/png, image/jpeg" class="hidden">
    <button onclick="document.getElementById('pngUpload').click()">Upload Avatar PNG</button>
  </div>

  <!-- CAMERA -->
  <div id="pageCamera" class="page hidden">
    <div id="cameraView"><video id="video" autoplay muted playsinline></video></div>
  </div>

  <!-- TEXT CHAT -->
  <div id="pageTextChat" class="page hidden">
    <div id="textChat"></div>
    <div id="textBar">
      <input id="msgInput" placeholder="Type a message">
      <button onclick="sendText()">Send</button>
    </div>
  </div>

  <!-- STORIES -->
  <div id="pageStories" class="page hidden">
    <div id="storiesList"></div>
    <div class="placeholder">Tap a friend‚Äôs circle to view their story</div>
  </div>

  <!-- GAMES -->
  <div id="pageGames" class="page hidden">
    <div style="padding:20px">
      <button onclick="loadGame('chess')">‚ôü Chess</button>
      <button onclick="loadGame('snakes')">üêç Snakes</button>
      <button onclick="inviteToGame()">Invite Friend</button>
    </div>
    <div id="gameBoard"></div>
  </div>

  <!-- ADD FRIENDS -->
  <div id="pageAdd" class="page hidden">
    <div id="addBox">
      <h3>Add Friend by Username</h3>
      <input id="searchUser" placeholder="Type username"><button onclick="searchUsername()">Search</button>
      <div id="userResults"></div>
    </div>
  </div>

  <!-- BOTTOM NAV -->
  <nav class="hidden" id="bottomNav">
    <button id="navChat" onclick="show('TextChat')">üí¨</button>
    <button id="navCamera" onclick="show('Camera')" class="active">üì∑</button>
    <button id="navStories" onclick="show('Stories')">üéØ</button>
    <button id="navGames" onclick="show('Games')">üéÆ</button>
    <button id="navAdd" onclick="show('Add')">‚ûï</button>
  </nav>

  <!-- FIREBASE -->
  <script type="module">
    import {initializeApp} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {getAuth,createUserWithEmailAndPassword,signInWithEmailAndPassword,updateProfile,onAuthStateChanged} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import {getDatabase,ref,set,push,onChildAdded,onValue,get} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import {getStorage,ref as sRef,uploadBytes,getDownloadURL} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCA0qYJrPtkRgjCNZTLVo5dfMG9W-O980U",
      authDomain: "flash-chat-cc8d5.firebaseapp.com",
      projectId: "flash-chat-cc8d5",
      storageBucket: "flash-chat-cc8d5.firebasestorage.app",
      messagingSenderId: "1024330564824",
      appId: "1:1024330564824:web:10e91cd0dc01246220c3ad"
    };
    const app=initializeApp(firebaseConfig);
    const auth=getAuth(app);
    const db=getDatabase(app);
    const storage=getStorage(app);

    let myId, myName, myEmoji='‚ö°Ô∏è', friendId='broadcast', customPhotoURL='';

    /* ---------- AUTH ---------- */
    window.login=()=>{
      const e=document.getElementById('email').value, p=document.getElementById('pass').value;
      signInWithEmailAndPassword(auth,e,p).catch(alert);
    };
    window.register=()=>{
      const e=document.getElementById('email').value, p=document.getElementById('pass').value;
      createUserWithEmailAndPassword(auth,e,p).then(cred=>{
        myId=cred.user.uid;
        const name=prompt('Pick a username'); if(!name)return;
        myName=name;
        updateProfile(cred.user,{displayName:name,photoURL:myEmoji});
        storeUser();
      }).catch(alert);
    };
    onAuthStateChanged(auth,user=>{
      if(user){
        myId=user.uid; myName=user.displayName||'User'; myEmoji=user.photoURL||'‚ö°Ô∏è'; customPhotoURL=user.customPhoto||'';
        document.getElementById('authPage').classList.add('hidden');
        document.getElementById('bottomNav').classList.remove('hidden');
        show('Camera'); startCamera(); storeUser(); loadFriends(); loadInbox(); loadStories(); notifyMe();
      }else{
        document.getElementById('authPage').classList.remove('hidden');
        document.getElementById('bottomNav').classList.add('hidden');
      }
    });
    function storeUser(){
      set(ref(db,'users/'+myId),{name:myName,emoji:myEmoji,customPhoto:customPhotoURL});
    }

    /* ---------- AVATAR ---------- */
    const emojiPool=['‚ö°Ô∏è','üî•','üòé','üöÄ','üåü','üíé','üéÆ','üì∏','ü§ç','ü¶ä'];
    window.addEventListener('DOMContentLoaded',()=>{
      const picker=document.getElementById('avatarPicker');
      emojiPool.forEach(e=>{
        const sp=document.createElement('span'); sp.textContent=e;
        sp.onclick=()=>{
          document.querySelectorAll('#avatarPicker span').forEach(s=>s.classList.remove('selected'));
          sp.classList.add('selected'); myEmoji=e; customPhotoURL='';
          if(auth.currentUser)updateProfile(auth.currentUser,{photoURL:e});
          storeUser();
        };
        picker.appendChild(sp);
      });
    });
    document.getElementById('pngUpload').addEventListener('change',e=>{
      const file=e.target.files[0]; if(!file)return;
      const storageRef=sRef(storage,'avatars/'+myId+'.'+file.name.split('.').pop());
      uploadBytes(storageRef,file).then(snapshot=>{
        getDownloadURL(snapshot.ref).then(url=>{
          customPhotoURL=url; myEmoji='';
          if(auth.currentUser)updateProfile(auth.currentUser,{photoURL:url});
          storeUser();
        });
      }).catch(alert);
    });

    /* ---------- NAV ---------- */
    window.show=p=>{
      document.querySelectorAll('.page').forEach(pg=>pg.classList.add('hidden'));
      document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
      document.getElementById('page'+p).classList.remove('hidden');
      document.getElementById('nav'+p).classList.add('active');
      if(p==='Camera') startCamera();
    };

    /* ---------- CAMERA ---------- */
    let stream;
    function startCamera(){
      if(stream)return;
      navigator.mediaDevices.getUserMedia({video:{facingMode:'user'},audio:false}).then(s=>{stream=s; document.getElementById('video').srcObject=s;});
    }
    document.getElementById('cameraView').addEventListener('click',takeSnap);
    function takeSnap(){
      const vid=document.getElementById('video'), can=document.createElement('canvas');
      can.width=vid.videoWidth; can.height=vid.videoHeight;
      can.getContext('2d').drawImage(vid,0,0);
      can.toBlob(blob=>{
        const r=new FileReader(); r.onloadend=()=>sendSnap(r.result); r.readAsDataURL(blob);
      });
    }
    function sendSnap(dataURL){
      const key=push(ref(db,'snaps')).key;
      const snapRef=sRef(storage,'snaps/'+key+'.jpg');
      uploadBytes(snapRef,dataURLToBlob(dataURL)).then(snapshot=>{
        getDownloadURL(snapshot.ref).then(url=>{
          push(ref(db,'inbox/'+friendId),{from:myId,url,expiry:Date.now()+10000});
        });
      });
    }
    function dataURLToBlob(dataURL){
      const [meta,base64]=dataURL.split(','), mime=meta.match(/:(.*?);/)[1];
      const b=atob(base64), u=new Uint8Array(b.length);
      for(let i=0;i<b.length;i++)u[i]=b.charCodeAt(i);
      return new Blob([u],{type:mime});
    }

    /* ---------- TEXT CHAT ---------- */
    window.sendText=()=>{
      const inp=document.getElementById('msgInput'), txt=inp.value.trim(); if(!txt)return;
      inp.value='';
      const msg={from:myId,text:txt,time:Date.now()};
      push(ref(db,'textChat/'+friendId),msg);
    };
    function loadInbox(){
      onChildAdded(ref(db,'textChat/'+friendId),snap=>{
        const m=snap.val(), div=document.createElement('div');
        div.className=m.from===myId?'bubble mine':'bubble theirs';
        div.textContent=m.text;
        document.getElementById('textChat').appendChild(div);
        document.getElementById('textChat').scrollTop=1e9;
      });
    }

    /* ---------- FRIENDS / SEARCH ---------- */
    window.searchUsername=()=>{
      const q=document.getElementById('searchUser').value.trim();
      if(!q)return;
      get(ref(db,'users')).then(ss=>{
        const res=document.getElementById('userResults'); res.innerHTML='';
        ss.forEach(c=>{
          const d=c.val(); if(d.name.toLowerCase()===q.toLowerCase()){
            const div=document.createElement('div');
            div.innerHTML=`${d.emoji||'üë§'} ${d.name} <button onclick="addFriend('${c.key}')">Add</button>`;
            res.appendChild(div);
          }
        });
      });
    };
    window.addFriend=fid=>{
      set(ref(db,'friends/'+myId+'/'+fid),true);
      set(ref(db,'friends/'+fid+'/'+myId),true);
      alert('Friend added!'); document.getElementById('userResults').innerHTML='';
    };
    function loadFriends(){
      onChildAdded(ref(db,'friends/'+myId),snap=>{
        const fid=snap.key;
        get(ref(db,'users/'+fid)).then(u=>{
          const d=u.val()||{};
          const avatarSrc=d.customPhoto||('data:image/svg+xml;base64,'+btoa(`<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40"><rect width="100%" height="100%" fill="#ff3b30"/><text x="50%" y="50%" font-size="26" fill="#fff" text-anchor="middle" dominant-baseline="middle">${d.emoji||'üë§'}</text></svg>`));
          const div=document.createElement('div'); div.className='chat';
          div.innerHTML=`<img class="avatar" src="${avatarSrc}"><div><b>${d.name||'User'}</b><br><button onclick="openText('${fid}')">Chat</button> <button onclick="startCall('${fid}',true)">üìπ</button> <button onclick="startCall('${fid}',false)">‚òéÔ∏è</button></div>`;
          document.getElementById('chatList').appendChild(div);
        });
      });
    }
    window.openText=fid=>{friendId=fid; document.getElementById('textChat').innerHTML=''; show('TextChat');};

    /* ---------- PUSH NOTIFICATIONS ---------- */
    function notifyMe(){
      if(!('Notification' in window))return;
      if(Notification.permission==='granted')return;
      if(Notification.permission!=='denied')Notification.requestPermission();
    }
    function pushNotify(title,body){
      if(Notification.permission==='granted')new Notification(title,{body,icon:'https://cdn-icons-png.flaticon.com/512/1384/1384030.png'});
    }
    onChildAdded(ref(db,'textChat/'+myId),snap=>{
      const m=snap.val(); if(m.from!==myId)pushNotify('Flash Network',m.text);
    });

    /* ---------- STORIES ---------- */
    function loadStories(){
      const list=document.getElementById('storiesList'); list.innerHTML='';
      get(ref(db,'friends/'+myId)).then(ss=>{
        ss.forEach(c=>{
          const fid=c.key;
          get(ref(db,'users/'+fid)).then(u=>{
            const d=u.val()||{};
            const slot=document.createElement('div'); slot.className='storySlot';
            const img=document.createElement('img');
            img.src=d.customPhoto||('data:image/svg+xml;base64,'+btoa(`<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="100%" height="100%" fill="#ff3b30"/><text x="50%" y="50%" font-size="32" fill="#fff" text-anchor="middle" dominant-baseline="middle">${d.emoji||'üë§'}</text></svg>`));
            img.onclick=()=>viewStory(fid);
            slot.appendChild(img); slot.appendChild(Object.assign(document.createElement('div'),{textContent:d.name||'User'}));
            list.appendChild(slot);
          });
        });
      });
    }
    window.viewStory=fid=>{
      get(ref(db,'stories/'+fid)).then(ss=>{
        const snaps=ss.val()||{}; const keys=Object.keys(snaps);
        if(keys.length===0)return alert('No stories');
        let idx=0;
        const viewer=document.createElement('div'); viewer.id='storyViewer';
        const img=document.createElement('img'); img.src=snaps[keys[idx]].url;
        const close=Object.assign(document.createElement('button'),{textContent:'‚úï'});
        close.onclick=()=>viewer.remove();
        viewer.appendChild(img); viewer.appendChild(close); document.body.appendChild(viewer);
        const next=()=>{idx++;if(keys[idx])img.src=snaps[keys[idx]].url;else viewer.remove();};
        viewer.onclick=next;
        setTimeout(next,5000);
      });
    };
    window.uploadStory=()=>{
      const inp=document.createElement('input'); inp.type='file'; inp.accept='image/*';
      inp.onchange=e=>{
        const file=e.target.files[0]; if(!file)return;
        const key=push(ref(db,'stories/'+myId)).key;
        const storyRef=sRef(storage,'stories/'+myId+'/'+key+'.jpg');
        uploadBytes(storyRef,file).then(snapshot=>{
          getDownloadURL(snapshot.ref).then(url=>{
            set(ref(db,'stories/'+myId+'/'+key),{url,expiry:Date.now()+86400000});
          });
        });
      }; inp.click();
    };

    /* ---------- GAMES ---------- */
    window.loadGame=g=>{
      const b=document.getElementById('gameBoard'); b.innerHTML='';
      if(g==='chess') b.innerHTML='<div id="board" style="width:80vmin;height:80vmin;display:grid;grid-template-columns:repeat(8,1fr);gap:1px;background:#444"></div>';
      if(g==='snakes') b.innerHTML='<p>üêç Snakes & Ladders ‚Äì dice roll coming soon</p>';
    };
    window.inviteToGame=()=>{
      if(friendId==='broadcast')return alert('Pick a friend first');
      push(ref(db,'gameInvites/'+friendId),{from:myId,game:'chess'});
      alert('Invite sent!');
    };
    onChildAdded(ref(db,'gameInvites/'+myId),snap=>{
      const inv=snap.val(); if(!inv)return;
      if(confirm('Play Chess?')){loadGame('chess'); show('Games');}
      snap.ref.remove();
    });

    /* ---------- WEBRTC CALLS ---------- */
    let localStream, peerConn, callChannel;
    const servers={iceServers:[{urls:'stun:stun.l.google.com:19302'}]};
    window.startCall=async(fid,video)=>{
      friendId=fid;
      localStream=await navigator.mediaDevices.getUserMedia({video,audio:true});
      peerConn=new RTCPeerConnection(servers);
      localStream.getTracks().forEach(t=>peerConn.addTrack(t,localStream));
      const offer=await peerConn.createOffer(); await peerConn.setLocalDescription(offer);
      push(ref(db,'calls/'+fid),{from:myId,offer,sdp:offer.sdp,type:offer.type});
      onChildAdded(ref(db,'calls/'+myId),async snap=>{
        const m=snap.val(); if(m.from!==fid)return;
        if(m.answer){ await peerConn.setRemoteDescription(new RTCSessionDescription(m.answer)); }
        if(m.ice){ try{peerConn.addIceCandidate(m.ice);}catch{} }
      });
      peerConn.onicecandidate=e=>{
        if(e.candidate) push(ref(db,'calls/'+fid),{from:myId,ice:e.candidate.toJSON()});
      };
      peerConn.ontrack=e=>{
        const remoteVideo=document.createElement('video'); remoteVideo.srcObject=e.streams[0];
        remoteVideo autoplay playsinline style="position:fixed;inset:0;width:100%;height:100%;object-fit:cover;z-index:998";
        document.body.appendChild(remoteVideo);
      };
    };

    /* ---------- PWA ---------- */
    if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
  </script>
</body>
</html>
